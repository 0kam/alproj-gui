name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.1.0)'
        required: true
        type: string

env:
  CARGO_INCREMENTAL: 0
  PYTHONUTF8: '1'

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-14
            target: aarch64-apple-darwin
            rust_target: aarch64-apple-darwin
            tauri_args: --target aarch64-apple-darwin
            pyinstaller_mode: onedir
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            rust_target: x86_64-unknown-linux-gnu
            tauri_args: --target x86_64-unknown-linux-gnu --no-bundle
            pyinstaller_mode: onedir
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            rust_target: x86_64-pc-windows-msvc
            tauri_args: --target x86_64-pc-windows-msvc
            pyinstaller_mode: onedir

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space on Linux runner
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          echo "Disk usage before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker system prune -af || true
          echo "Disk usage after cleanup:"
          df -h

      # ============================================
      # System Dependencies
      # ============================================
      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libsoup-3.0-dev \
            librsvg2-dev \
            patchelf \
            libfuse2 \
            libglib2.0-dev \
            libgdal-dev

      # ============================================
      # Python Setup (for backend sidecar)
      # ============================================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: 'latest'

      - name: Install backend dependencies
        working-directory: backend
        run: |
          uv sync --group dev --frozen

      - name: Use CPU-only PyTorch on Linux
        if: matrix.platform == 'ubuntu-22.04'
        working-directory: backend
        run: |
          set -euo pipefail

          # Reinstall CPU wheels from the PyTorch CPU index.
          uv pip install --python .venv/bin/python \
            --index-url https://download.pytorch.org/whl/cpu \
            --upgrade --force-reinstall \
            torch==2.10.0 torchvision==0.25.0 torchaudio==2.10.0

          # Remove CUDA-related packages that may have been installed by uv sync.
          CUDA_PKGS=$(uv run python - <<'PY'
          import importlib.metadata as md

          names = []
          for dist in md.distributions():
              name = dist.metadata.get("Name", "").strip()
              lname = name.lower()
              if lname.startswith("nvidia-") or lname in {"triton", "cuda-bindings"}:
                  names.append(name)
          print(" ".join(sorted(set(names))))
          PY
          )

          if [ -n "$CUDA_PKGS" ]; then
            uv pip uninstall --python .venv/bin/python $CUDA_PKGS
          fi

          # Sanity-check Linux torch build metadata.
          uv run python - <<'PY'
          import importlib.metadata as md
          import torch

          leftovers = sorted(
              name
              for name in (d.metadata.get("Name", "").strip() for d in md.distributions())
              if name.lower().startswith("nvidia-") or name.lower() in {"triton", "cuda-bindings"}
          )
          print(f"torch.version.cuda={torch.version.cuda}")
          print(f"cuda_related_packages={leftovers}")
          PY

      # ============================================
      # Build Python Backend Sidecar
      # ============================================
      - name: Build backend sidecar (Unix)
        if: matrix.platform != 'windows-latest'
        working-directory: backend
        run: |
          RASTERIO_PROJ_DATA=$(uv run python -c "import rasterio, os; print(os.path.join(os.path.dirname(rasterio.__file__), 'proj_data'))")
          RASTERIO_GDAL_DATA=$(uv run python -c "import rasterio, os; print(os.path.join(os.path.dirname(rasterio.__file__), 'gdal_data'))")
          PYPROJ_DATA=$(uv run python -c "import pyproj; print(pyproj.datadir.get_data_dir())")

          uv run pyinstaller \
            --${{ matrix.pyinstaller_mode }} \
            --name "backend-sidecar" \
            --clean \
            --noconfirm \
            --noupx \
            --log-level WARN \
            --add-data "$RASTERIO_PROJ_DATA:proj_data" \
            --add-data "$RASTERIO_GDAL_DATA:gdal_data" \
            --add-data "$PYPROJ_DATA:pyproj_data" \
            --collect-all "PIL" \
            --collect-all "pillow_heif" \
            --collect-all "imm" \
            --hidden-import "PIL._imaging" \
            --hidden-import "PIL._imagingft" \
            --hidden-import "app" \
            --hidden-import "uvicorn" \
            --hidden-import "uvicorn.logging" \
            --hidden-import "uvicorn.loops" \
            --hidden-import "uvicorn.loops.auto" \
            --hidden-import "uvicorn.protocols" \
            --hidden-import "uvicorn.protocols.http" \
            --hidden-import "uvicorn.protocols.http.auto" \
            --hidden-import "uvicorn.protocols.websockets" \
            --hidden-import "uvicorn.protocols.websockets.auto" \
            --hidden-import "uvicorn.lifespan" \
            --hidden-import "uvicorn.lifespan.on" \
            --hidden-import "fastapi" \
            --hidden-import "pydantic" \
            --hidden-import "rasterio" \
            --hidden-import "rasterio.sample" \
            --hidden-import "rasterio.vrt" \
            --hidden-import "rasterio.crs" \
            --hidden-import "rasterio.transform" \
            --hidden-import "rasterio.warp" \
            --hidden-import "rasterio.features" \
            --hidden-import "rasterio.mask" \
            --hidden-import "rasterio.merge" \
            --hidden-import "rasterio.plot" \
            --hidden-import "rasterio.rio" \
            --hidden-import "rasterio._io" \
            --hidden-import "rasterio._features" \
            --hidden-import "rasterio._warp" \
            --collect-submodules "rasterio" \
            --hidden-import "numpy" \
            --hidden-import "cv2" \
            --hidden-import "imm" \
            --hidden-import "torch" \
            --hidden-import "torchvision" \
            --hidden-import "kornia" \
            --hidden-import "huggingface_hub" \
            --add-data "app:app" \
            app/main.py

          # Model weights are downloaded on demand at runtime; do not bundle them.
          rm -rf dist/backend-sidecar/_internal/imm/model_weights

      - name: Smoke test backend sidecar (Unix)
        if: matrix.platform != 'windows-latest'
        continue-on-error: true
        working-directory: backend
        run: |
          set -euo pipefail
          SIDECARENTRY="backend-sidecar"
          SIDECARDIR="dist/backend-sidecar"
          LOGFILE="$RUNNER_TEMP/backend-sidecar-smoke.log"

          pushd "$SIDECARDIR" >/dev/null
          "./$SIDECARENTRY" --host 127.0.0.1 --port 18765 >"$LOGFILE" 2>&1 &
          SIDECAR_PID=$!
          popd >/dev/null

          cleanup() {
            kill "$SIDECAR_PID" >/dev/null 2>&1 || true
            wait "$SIDECAR_PID" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          if ! uv run python - <<'PY'
          import json
          import time
          import urllib.request
          from urllib.error import URLError

          deadline = time.time() + 120
          url = "http://127.0.0.1:18765/api/health"
          while time.time() < deadline:
              try:
                  with urllib.request.urlopen(url, timeout=2) as resp:
                      if resp.status == 200:
                          payload = json.loads(resp.read().decode("utf-8"))
                          if payload.get("status") == "ok":
                              raise SystemExit(0)
              except URLError:
                  pass
              time.sleep(0.5)
          raise SystemExit(1)
          PY
          then
            echo "Backend sidecar smoke test failed (Unix)"
            tail -n 200 "$LOGFILE" || true
            exit 1
          fi

      - name: Build backend sidecar (Windows)
        if: matrix.platform == 'windows-latest'
        working-directory: backend
        shell: pwsh
        run: |
          $RASTERIO_PROJ_DATA = uv run python -c "import rasterio, os; print(os.path.join(os.path.dirname(rasterio.__file__), 'proj_data'))"
          $RASTERIO_GDAL_DATA = uv run python -c "import rasterio, os; print(os.path.join(os.path.dirname(rasterio.__file__), 'gdal_data'))"
          $PYPROJ_DATA = uv run python -c "import pyproj; print(pyproj.datadir.get_data_dir())"

          uv run pyinstaller `
            --onedir `
            --name "backend-sidecar" `
            --clean `
            --noconfirm `
            --noupx `
            --log-level WARN `
            --add-data "$RASTERIO_PROJ_DATA;proj_data" `
            --add-data "$RASTERIO_GDAL_DATA;gdal_data" `
            --add-data "$PYPROJ_DATA;pyproj_data" `
            --collect-all "PIL" `
            --collect-all "pillow_heif" `
            --collect-all "imm" `
            --hidden-import "PIL._imaging" `
            --hidden-import "PIL._imagingft" `
            --hidden-import "app" `
            --hidden-import "uvicorn" `
            --hidden-import "uvicorn.logging" `
            --hidden-import "uvicorn.loops" `
            --hidden-import "uvicorn.loops.auto" `
            --hidden-import "uvicorn.protocols" `
            --hidden-import "uvicorn.protocols.http" `
            --hidden-import "uvicorn.protocols.http.auto" `
            --hidden-import "uvicorn.protocols.websockets" `
            --hidden-import "uvicorn.protocols.websockets.auto" `
            --hidden-import "uvicorn.lifespan" `
            --hidden-import "uvicorn.lifespan.on" `
            --hidden-import "fastapi" `
            --hidden-import "pydantic" `
            --hidden-import "rasterio" `
            --hidden-import "rasterio.sample" `
            --hidden-import "rasterio.vrt" `
            --hidden-import "rasterio.crs" `
            --hidden-import "rasterio.transform" `
            --hidden-import "rasterio.warp" `
            --hidden-import "rasterio.features" `
            --hidden-import "rasterio.mask" `
            --hidden-import "rasterio.merge" `
            --hidden-import "rasterio.plot" `
            --hidden-import "rasterio.rio" `
            --hidden-import "rasterio._io" `
            --hidden-import "rasterio._features" `
            --hidden-import "rasterio._warp" `
            --collect-submodules "rasterio" `
            --hidden-import "numpy" `
            --hidden-import "cv2" `
            --hidden-import "imm" `
            --hidden-import "torch" `
            --hidden-import "torchvision" `
            --hidden-import "kornia" `
            --hidden-import "huggingface_hub" `
            --add-data "app;app" `
            app/main.py

          # Model weights are downloaded on demand at runtime; do not bundle them.
          $weightsDir = Join-Path $PWD "dist/backend-sidecar/_internal/imm/model_weights"
          if (Test-Path $weightsDir) {
            Remove-Item -Recurse -Force $weightsDir
          }

      - name: Smoke test backend sidecar (Windows)
        if: matrix.platform == 'windows-latest'
        continue-on-error: true
        working-directory: backend
        shell: pwsh
        run: |
          $sidecarDir = Join-Path $PWD "dist/backend-sidecar"
          $sidecar = Join-Path $sidecarDir "backend-sidecar.exe"
          $stdoutLog = Join-Path $env:RUNNER_TEMP "backend-sidecar-smoke.stdout.log"
          $stderrLog = Join-Path $env:RUNNER_TEMP "backend-sidecar-smoke.stderr.log"
          $proc = Start-Process `
            -FilePath $sidecar `
            -WorkingDirectory $sidecarDir `
            -ArgumentList "--host","127.0.0.1","--port","18765" `
            -RedirectStandardOutput $stdoutLog `
            -RedirectStandardError $stderrLog `
            -PassThru

          try {
            $deadline = (Get-Date).AddSeconds(120)
            $ready = $false
            while ((Get-Date) -lt $deadline) {
              Start-Sleep -Milliseconds 500
              try {
                $response = Invoke-WebRequest -Uri "http://127.0.0.1:18765/api/health" -UseBasicParsing -TimeoutSec 2
                if ($response.StatusCode -eq 200) {
                  $ready = $true
                  break
                }
              } catch {}

              if ($proc.HasExited) {
                break
              }
            }

            if (-not $ready) {
              if ($proc.HasExited) {
                Write-Host "Backend sidecar exited early with code: $($proc.ExitCode)"
              }
              if (Test-Path $stdoutLog) {
                Write-Host "--- stdout tail ---"
                Get-Content $stdoutLog -Tail 120
              }
              if (Test-Path $stderrLog) {
                Write-Host "--- stderr tail ---"
                Get-Content $stderrLog -Tail 120
              }
              throw "Backend sidecar smoke test failed (Windows)"
            }
          } finally {
            if (-not $proc.HasExited) {
              Stop-Process -Id $proc.Id -Force
            }
          }

      - name: Copy sidecar to Tauri binaries (macOS onedir)
        if: startsWith(matrix.platform, 'macos')
        run: |
          rm -rf src-tauri/binaries/sidecar-${{ matrix.target }}
          mkdir -p src-tauri/binaries
          mv backend/dist/backend-sidecar src-tauri/binaries/sidecar-${{ matrix.target }}
          mv src-tauri/binaries/sidecar-${{ matrix.target }}/backend-sidecar \
            src-tauri/binaries/sidecar-${{ matrix.target }}/backend-sidecar-${{ matrix.target }}
          chmod +x src-tauri/binaries/sidecar-${{ matrix.target }}/backend-sidecar-${{ matrix.target }}

      - name: Copy sidecar to Tauri binaries (Linux onedir)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          rm -rf src-tauri/binaries/sidecar-${{ matrix.target }}
          mkdir -p src-tauri/binaries
          mv backend/dist/backend-sidecar src-tauri/binaries/sidecar-${{ matrix.target }}
          mv src-tauri/binaries/sidecar-${{ matrix.target }}/backend-sidecar \
            src-tauri/binaries/sidecar-${{ matrix.target }}/backend-sidecar-${{ matrix.target }}
          chmod +x src-tauri/binaries/sidecar-${{ matrix.target }}/backend-sidecar-${{ matrix.target }}

      - name: Copy sidecar to Tauri binaries (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force src-tauri/binaries/sidecar-${{ matrix.target }} -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path src-tauri/binaries | Out-Null
          Move-Item -Force backend/dist/backend-sidecar src-tauri/binaries/sidecar-${{ matrix.target }}
          Rename-Item `
            -Path src-tauri/binaries/sidecar-${{ matrix.target }}/backend-sidecar.exe `
            -NewName backend-sidecar-${{ matrix.target }}.exe

      - name: Cleanup backend build files (Unix)
        if: matrix.platform != 'windows-latest'
        run: |
          rm -rf backend/.venv backend/build backend/dist backend/models
          rm -rf ~/.cache/pip ~/.cache/uv

      - name: Cleanup backend build files (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force backend/.venv,backend/build,backend/dist,backend/models -ErrorAction SilentlyContinue

      # ============================================
      # Node.js Setup (for frontend)
      # ============================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci --legacy-peer-deps

      # ============================================
      # Rust Setup (for Tauri)
      # ============================================
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Rust cache
        if: matrix.platform != 'ubuntu-22.04'
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Configure Linux build directories
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo mkdir -p /mnt/alproj-target /mnt/tmp
          sudo chown -R "$USER":"$USER" /mnt/alproj-target /mnt/tmp
          rm -rf src-tauri/target
          ln -s /mnt/alproj-target src-tauri/target
          echo "CARGO_TARGET_DIR=/mnt/alproj-target" >> "$GITHUB_ENV"
          echo "TMPDIR=/mnt/tmp" >> "$GITHUB_ENV"
          echo "TMP=/mnt/tmp" >> "$GITHUB_ENV"
          echo "TEMP=/mnt/tmp" >> "$GITHUB_ENV"
          df -h

      # ============================================
      # Build Tauri App
      # ============================================
      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: src-tauri
          args: ${{ matrix.tauri_args }}

      - name: Build Linux tarball package
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          set -euo pipefail

          VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          PKG_ROOT="dist-linux/alproj-gui-linux-x86_64"
          PAYLOAD_DIR="$PKG_ROOT/payload"

          rm -rf dist-linux
          mkdir -p \
            "$PAYLOAD_DIR/binaries" \
            "$PAYLOAD_DIR/share/applications" \
            "$PAYLOAD_DIR/share/icons/hicolor/128x128/apps"

          install -Dm755 \
            "src-tauri/target/${{ matrix.rust_target }}/release/alproj-gui" \
            "$PAYLOAD_DIR/alproj-gui"
          cp -a \
            "src-tauri/binaries/sidecar-${{ matrix.target }}" \
            "$PAYLOAD_DIR/binaries/"
          install -Dm644 \
            "packaging/flatpak/com.alproj.gui.desktop" \
            "$PAYLOAD_DIR/share/applications/com.alproj.gui.desktop"
          install -Dm644 \
            "src-tauri/icons/128x128.png" \
            "$PAYLOAD_DIR/share/icons/hicolor/128x128/apps/com.alproj.gui.png"

          install -Dm755 "packaging/linux/install.sh" "$PKG_ROOT/install.sh"
          install -Dm755 "packaging/linux/uninstall.sh" "$PKG_ROOT/uninstall.sh"
          install -Dm755 "packaging/linux/update.sh" "$PKG_ROOT/update.sh"
          install -Dm644 "packaging/linux/README-linux.md" "$PKG_ROOT/README-linux.md"
          printf '%s\n' "$VERSION" > "$PKG_ROOT/VERSION"

          tar -C dist-linux -czf \
            "dist-linux/ALPROJ.GUI_${VERSION}_linux_x86_64.tar.gz" \
            "alproj-gui-linux-x86_64"
          ls -lh dist-linux/*.tar.gz

      # ============================================
      # Upload Artifacts
      # ============================================
      - name: Upload artifacts (macOS)
        if: startsWith(matrix.platform, 'macos')
        uses: actions/upload-artifact@v4
        with:
          name: alproj-gui-${{ matrix.target }}
          path: |
            src-tauri/target/${{ matrix.rust_target }}/release/bundle/dmg/*.dmg
          if-no-files-found: error

      - name: Upload artifacts (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        uses: actions/upload-artifact@v4
        with:
          name: alproj-gui-${{ matrix.target }}
          path: |
            dist-linux/*.tar.gz
          if-no-files-found: error

      - name: Upload artifacts (Windows)
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: alproj-gui-${{ matrix.target }}
          path: |
            src-tauri/target/${{ matrix.rust_target }}/release/bundle/msi/*.msi
            src-tauri/target/${{ matrix.rust_target }}/release/bundle/nsis/*.exe
          if-no-files-found: error

  # ============================================
  # Create GitHub Release
  # ============================================
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    permissions:
      contents: write

    steps:
      - name: Resolve release tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f | head -200

      - name: Validate Linux bundle type
        run: |
          set -euo pipefail
          deb_count=$(find artifacts -type f -name "*.deb" | wc -l | tr -d ' ')
          if [ "$deb_count" -gt 0 ]; then
            echo "Unexpected .deb artifact detected. Linux release must be tar.gz-only."
            find artifacts -type f -name "*.deb"
            exit 1
          fi
          appimage_count=$(find artifacts -type f -name "*.AppImage" | wc -l | tr -d ' ')
          if [ "$appimage_count" -gt 0 ]; then
            echo "Unexpected .AppImage artifact detected. Linux release must be tar.gz-only."
            find artifacts -type f -name "*.AppImage"
            exit 1
          fi
          flatpak_count=$(find artifacts -type f -name "*.flatpak" | wc -l | tr -d ' ')
          if [ "$flatpak_count" -gt 0 ]; then
            echo "Unexpected .flatpak artifact detected. Linux release must be tar.gz-only."
            find artifacts -type f -name "*.flatpak"
            exit 1
          fi

      - name: Validate Linux tarball size (<1GB)
        run: |
          set -euo pipefail
          limit=1000000000
          tar_count=0
          while IFS= read -r -d '' file; do
            tar_count=$((tar_count + 1))
            size=$(stat -c%s "$file")
            if [ "$size" -ge "$limit" ]; then
              echo "Asset exceeds 1GB limit: $file (${size} bytes)"
              exit 1
            fi
            echo "OK: $file (${size} bytes)"
          done < <(find artifacts -type f -name "*.tar.gz" -print0)

          if [ "$tar_count" -eq 0 ]; then
            echo "No Linux .tar.gz artifact found"
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          target_commitish: ${{ github.sha }}
          draft: true
          generate_release_notes: true
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.tar.gz
            artifacts/**/*.msi
            artifacts/**/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
