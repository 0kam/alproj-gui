# 機能仕様書: オルソ化

**機能ブランチ**: `001-georectification`
**作成日**: 2025-01-27
**ステータス**: ドラフト
**入力**: 景観写真のオルソ化（地理座標補正）機能

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 基本的なオルソ化実行 (優先度: P1)

研究者または自治体職員が、山岳地域で撮影した写真を地理座標付きの画像（GeoTIFF）に変換する。
ウィザード形式のUIに従って必要なデータを入力し、処理を実行し、結果をダウンロードする。

**この優先度の理由**: これがアプリケーションの核心機能であり、この機能なしでは価値を提供できない。

**独立テスト**: サンプルデータ（DSM、航空写真、景観写真）を使用して、GeoTIFF が正常に出力されることを確認できる。

**受け入れシナリオ**:

1. **Given** ユーザーがアプリを起動している, **When** 「新規プロジェクト」を選択する, **Then** オルソ化ウィザードが開始される
2. **Given** ウィザードのデータ入力画面にいる, **When** DSMファイル、航空写真、対象画像を選択する, **Then** 各ファイルのプレビューと基本情報（サイズ、座標系等）が表示される
3. **Given** 初期パラメータ入力画面にいる, **When** 地図上でカメラ位置をクリックし、撮影方向と視野角をドラッグで調整する, **Then** 地図上に扇形の視野範囲が表示され、シミュレーション画像がプレビュー表示される
4. **Given** 処理実行画面にいる, **When** 「処理開始」を押す, **Then** 進捗バーと現在のステップが表示され、処理が進行する
5. **Given** 処理が完了した, **When** 結果確認画面が表示される, **Then** 元画像と補正後画像の比較、精度指標（RMSE等）が表示される
6. **Given** 結果確認画面にいる, **When** 「エクスポート」を押す, **Then** GeoTIFF ファイルが指定した場所に保存される

---

### ユーザーストーリー 2 - 処理パラメータの詳細調整 (優先度: P2)

経験のあるユーザーが、自動処理の結果に満足できない場合に、各ステップのパラメータを
手動で調整して精度を向上させる。

**この優先度の理由**: 自動処理だけでは対応できないケースがあり、専門家が介入できる必要がある。ただし基本機能が先。

**独立テスト**: 自動処理後に任意のステップに戻り、パラメータを変更して再処理し、結果が改善されることを確認できる。

**受け入れシナリオ**:

1. **Given** 処理結果画面にいる, **When** 「詳細設定」を展開する, **Then** 最適化パラメータ、マッチング設定などが表示される
2. **Given** 詳細設定画面にいる, **When** GCP（地上基準点）の一覧を表示する, **Then** 各GCPの位置、残差、使用/除外状態が確認できる
3. **Given** GCP一覧画面にいる, **When** 特定のGCPを除外する, **Then** そのGCPが最適化計算から除外される
4. **Given** パラメータを変更した, **When** 「再処理」を押す, **Then** 変更したステップ以降のみが再計算される

---

### ユーザーストーリー 3 - プロジェクトの保存と再開 (優先度: P3)

ユーザーが作業途中の状態を保存し、後日続きから再開する。
また、過去のプロジェクトを開いて結果を確認したり、パラメータを調整して再処理する。

**この優先度の理由**: 長時間の処理や複数セッションでの作業に必要だが、基本機能と詳細調整の後でよい。

**独立テスト**: プロジェクトを保存し、アプリを再起動した後に開いて、すべての設定と結果が復元されることを確認できる。

**受け入れシナリオ**:

1. **Given** 処理中または処理後の状態にある, **When** 「プロジェクトを保存」を選択する, **Then** プロジェクトファイル（.alproj）が作成される
2. **Given** アプリを起動している, **When** 既存のプロジェクトファイルを開く, **Then** 保存時の状態が復元される（入力データへの参照、パラメータ、処理結果）
3. **Given** 過去のプロジェクトを開いている, **When** パラメータを変更して再処理する, **Then** 新しい結果で上書きされ、変更履歴が記録される

---

### エッジケース

- DSMと航空写真の座標系が異なる場合、警告を表示し座標変換を提案する
- 対象画像の EXIF に GPS 情報がある場合、初期パラメータの参考値として提示する
- 処理中にアプリが強制終了した場合、次回起動時に復旧ダイアログを表示する（処理開始前に一時ファイルとして自動保存された状態から復旧）
- メモリ不足で処理が失敗した場合、エラーメッセージで推奨解像度を提示し、ユーザーが手動でデータを再選択する
- 画像マッチングで十分な対応点が見つからない場合、エラーメッセージでアルゴリズム変更や初期パラメータ調整を提案する（自動切替はしない）

## 要件 *(必須)*

### 機能要件

**データ入力**:
- **FR-001**: システムは GeoTIFF 形式の DSM（数値表層モデル）を読み込めること（MUST）
- **FR-002**: システムは GeoTIFF 形式の航空写真/オルソ画像を読み込めること（MUST）
- **FR-003**: システムは JPEG/PNG/TIFF 形式の景観写真を読み込めること（MUST）
- **FR-004**: システムは読み込んだファイルのプレビューと基本情報を表示すること（MUST）
- **FR-005**: システムは座標系（CRS）の不一致を検出し、警告を表示すること（MUST）

**初期パラメータ設定**:
- **FR-006**: システムはカメラ位置（緯度、経度、標高）の入力を受け付けること（MUST）
- **FR-007**: システムはカメラ方向（パン、チルト、ロール）の入力を受け付けること（MUST）
- **FR-008**: システムは視野角（FOV）の入力を受け付けること（MUST）
- **FR-009**: システムは地図上でカメラ位置をクリック/ドラッグで設定できること（MUST）
- **FR-010**: システムは地図上でカメラの撮影方向を視覚的に設定できること（MUST）
- **FR-011**: システムは地図上で視野角（FOV）を扇形で表示し、ドラッグで調整できること（MUST）
- **FR-012**: システムは入力されたパラメータに基づくシミュレーション画像をリアルタイムでプレビュー表示すること（SHOULD）
- **FR-013**: システムは EXIF データから初期パラメータの推定値を提案すること（GPS位置 → x, y, z、焦点距離 → FOV）（SHOULD）
- **FR-014**: システムは地図表示と対象画像を並べて表示し、設定の確認を容易にすること（SHOULD）

**処理実行**:
- **FR-015**: システムは画像マッチングによる GCP（地上基準点）の自動検出を行うこと（MUST）
- **FR-016**: システムはカメラパラメータの自動最適化を行うこと（MUST）
- **FR-017**: システムは処理の進捗状況（ステップ名、進捗率、経過時間）を表示すること（MUST）
- **FR-018**: システムは処理のキャンセルを受け付けること（MUST）
- **FR-019**: システムは処理中のエラーをユーザーに分かりやすく通知すること（MUST）

**結果表示**:
- **FR-020**: システムは補正後の画像をプレビュー表示すること（MUST）
- **FR-021**: システムは精度指標（RMSE、GCP数、残差分布）を表示すること（MUST）
- **FR-022**: システムは元画像と補正後画像の重ね合わせ表示を提供すること（SHOULD）
- **FR-023**: システムは GCP の位置と残差を地図上または画像上に表示すること（SHOULD）

**エクスポート**:
- **FR-024**: システムは補正後の画像を GeoTIFF 形式で出力すること（MUST）
- **FR-025**: システムは出力解像度（メートル/ピクセル）を指定できること（MUST）
- **FR-026**: システムは出力座標系を指定できること（SHOULD）
- **FR-027**: システムは処理レポート（使用パラメータ、精度指標）を出力できること（SHOULD）

**プロジェクト管理**:
- **FR-028**: システムはプロジェクトを独自形式（.alproj）で保存できること（MUST）
- **FR-029**: システムは保存したプロジェクトを開いて復元できること（MUST）
- **FR-030**: システムはプロジェクトファイルのバージョン互換性を管理すること（MUST）

**詳細調整**:
- **FR-031**: システムは GCP の手動追加/削除を許可すること（SHOULD）
- **FR-032**: システムは最適化パラメータ（世代数、誤差関数など）の調整を許可すること（SHOULD）
- **FR-033**: システムはマッチングアルゴリズムの選択を許可すること（SHOULD）

### 主要エンティティ

- **プロジェクト**: オルソ化作業の単位。入力データへの参照、パラメータ設定、処理結果を含む。バージョン管理され、ファイルとして保存可能。
- **入力データセット**: DSM、航空写真、対象画像の組み合わせ。各ファイルのパス、座標系、メタデータを保持。
- **カメラパラメータ**: カメラの位置（x, y, z）、方向（pan, tilt, roll）、光学特性（fov, レンズ歪み係数）。初期値と最適化後の値を区別。
- **GCP（地上基準点）**: 対象画像とシミュレーション画像間の対応点。画像座標と地理座標のペア、残差、有効/無効フラグを持つ。
- **処理結果**: 補正後の画像データ、精度指標（RMSE、残差分布）、処理ログ。

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 初めてのユーザーが、devel_data/ のサンプルデータ（example.py 参照）を使用して GeoTIFF を出力するまでに 15 分以内で完了できる
- **SC-002**: 処理の各ステップで進捗が視覚的に確認でき、ユーザーが「処理が止まった」と感じない
- **SC-003**: 処理失敗時に、ユーザーが次に何をすべきか理解できるエラーメッセージが表示される
- **SC-004**: 保存したプロジェクトを再度開いたとき、すべての設定と結果が正確に復元される
- **SC-005**: 出力された GeoTIFF が一般的な GIS ソフトウェア（QGIS など）で正常に開ける

## Clarifications

### Session 2026-01-27

- Q: 処理中にアプリが強制終了した場合の復旧レベルは？ → A: 自動保存（処理開始前に一時ファイル保存。再起動時に復旧ダイアログ表示）
- Q: メモリ不足時のダウンサンプリング対応は？ → A: 提案のみ（エラーメッセージで推奨解像度を提示し、ユーザーが手動で再選択）
- Q: SC-001 の測定基準データは？ → A: devel_data/ のサンプルデータ（DSM: 5.8MB, 航空写真: 2.1GB, 対象画像: 5616x3744px）を使用
- Q: EXIF から推定するパラメータは？ → A: GPS 位置（緯度、経度、標高 → x, y, z）+ 焦点距離から FOV を推定
- Q: 画像マッチング失敗時の対応は？ → A: 提案のみ（エラーメッセージでアルゴリズム変更や初期パラメータ調整を提案）

## 前提条件

- ユーザーは DSM と航空写真を事前に入手している（これらのデータ取得はアプリのスコープ外）
- ユーザーはカメラ位置の概算（地図上で確認できる程度）を把握している
- 対象画像は山岳地域を撮影したもので、DSM/航空写真の範囲内にある
- alproj ライブラリの機能をそのまま使用し、アルゴリズム自体の改良は行わない
